---
title: 'The River Ouse Project: Meadow Surveys Data Analysis'
author: John Pilkington
date: "2023-05-16"
output:
  html_document: 
     keep_md: TRUE
     
  code_folding: hide
  df_print: paged
  fig.width: 3
  fig.height: 2
     
bibliography: references.bib

---    
<style type="text/css">
   .main-container {max-width: 100%;}
   .row {display: flex;}
   .column {flex: 50%;}
</style>
---
```{css, echo=FALSE}
h1, h2 {text-align: center;}
```

```{r setup, include = FALSE, echo = FALSE, message = FALSE, error = FALSE, warnings = FALSE}
load(".RData")
library(tidyverse)
library(igraph)
library(ggraph)
library(tidygraph)
library(RColorBrewer)
library(knitr)
library(kableExtra)
```

# 1. Introduction
The River Ouse Project has accumulated plant survey results from over 150 meadows (http://www.sussex.ac.uk/riverouse/). There is a need to summarise the data, visually if possible, to reveal any community structures present. A graph theoretical approach (Stochastic Block Model,SBM^[1]) identifies community structures in the data, but this does not necessarily mean that they are expressed in the field. The term "latent communities" is intended to cover this situation. Latent communities may be more or less expressed at any site; what follows is a description of the latent communities in the data, and an analysis of their expression by survey site. 

<div class = "row">
<div class = "column">

![Figure 1. ](Figures/Latent community summary.png){width=100%}

</div>
<div class = "column">

Latent community expression at survey sites is presumably conditioned by site environment, an idea encapsulated in Figure 1. Here we have the latent communities on the left and their manifestation at the survey sites on the right. In between, the boxes labelled "Environment" are what is called in the literature a "filtering framework". I quote: "the abiotic conditions define the environmental filters selecting species from a regional species pool ..." [@DosAndDonts]. My scheme agrees with this in the presence of a filtering framework, but the latent communities are NOT the same as a species pool, also known as a Community Pool (CP). Here's the difference:

* **Community Pool** envisages a set of *species* that may be drawn upon to make up the *community* manifest at a particular site. 
* **Latent Community** envisages a set of *communities* that may be drawn upon to make up the set of *species* present at a particular site.

The conceptual distinction is significant:

* several latent communities may be expressed at a site.
* partial LC membership is included in a natural way.
The results reported here depend heavily upon the R package SBM [@SBMpackage].

</div>
</div>


# 2. Latent communities
According to this scheme, a latent community is a set of *relationships between pairs of plants* such that they occur together in the data more or less frequently than would be expected by chance (p < 0.05). These plant pairs are called dyads, and they may be associative (occur together more frequently than would be expected) or dissociative.

The links between dyads are counted in assessing latent community expression at a site; in order to be counted, both elements of the dyad must be present. Latent community expression at a site is the proportion of links present at the site, expressed as percent of the links in the parent graph. More formally:

1. Write G~l~ for the graph of Latent Community l, which has size (number of links) r~l~.
2. Write G~ls~ for the subgraph of G~l~ represented at site s, which has size r~ls~.

Then the expression X~ls~ of Latent Community l at site s is X~ls~ = 100r~ls~/r~l~

```{r echo = FALSE, results = "asis"}
pm <- the_model$connectParam$mean %>% as_tibble()
pm1 <- pm %>%  rename(LC1 = 1, LC2 = 2, LC3 = 3, LC4 = 4, LC5 = 5, LC6 = 6, LC7 = 7, LC8 = 8) %>%
  mutate_if(
    is.numeric,
    function(x) {
      formatC(x, digits = 3, format = "f")
    })

for (i in 1:(ncol(pm))) {
  pm1[i,i] <- cell_spec(pm1[i, i], bold=T, background = "lightgray", color = ifelse(pm[i,i] == max(pm[,i]), "red", "black"))
}
kable(pm1, caption = "Table 1. Model parameters", escape = F) %>%
kable_styling(bootstrap_options = "striped", full_width = F, position = "float_right")
rm(pm, pm1)
```

The dyads are the observed data. The SBM builds a representation of the uncertain nature of the data by assigning probabilities to the links. The probabilities form blocks such that the probability of links between dyads within a block differs from the probability of links between dyads ending in different blocks. Generally, in-block probabilities are greater than out-block probabilities, forming positive groups of dyads[@SBMreview]. In our case, there are eight blocks. The model is summed up by an 8x8 matrix. The values on the leading diagonal are the in-block probabilities, the off-diagonal values are the probabilities of finding links between the corresponding blocks. The matrix is shown in Table 1. The in-block probabilities in the leading diagonal are shown in bold face, and the text is red when the in-block probability is greater than the out-block probabilities. Latent communities (blocks) 1 - 5 are good, 6 needs to be treated with caution, and the probabilities for 7 and 8 are so low that they may best be ignored (the probabilities are about 1/3 that of LC6, and they contain species that are poorly represented in the data).

The SBM is not told anything about the associative or dissociative nature of the links it is modelling. That information is added later, see [Associative and dissociative links](#section4). 
Details of the latent communities follow. For each, there is a graph and a table. The graphs are useful in visualising the contribution of associative and dissociative links. The size of the species symbols is an indication of the species frequency in the data. The tables list the species in the dyads of which the latent community is composed, the count of their occurrence in the data, and the frequency with which they were found at survey sites.

### Latent Community 1.

<div class = "row">
<div class = "column">

![](Figures/Latent community 1.png){width=100%}
</div>
<div class = "column">

```{r echo = FALSE, results = "asis"}
lc_n <- g1 %>% activate(nodes) %>% as_tibble()
lc_n %>% filter(latent_community == 1) %>%  mutate(num(frequency, sigfig = 3)) %>%
    select(-frequency, -latent_community) %>% rename(frequency = 3) %>%   
    kbl(caption = "Latent Community 1 species", escape = F) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, font_size = 12)
```
</div>
</div>


### Latent Community 2.

<div class = "row">
<div class = "column">

![](Figures/Latent community 2.png)
</div>
<div class = "column">

```{r echo = FALSE, results = "asis"}
lc_n <-  g1 %>% activate(nodes) %>% as_tibble() %>% filter(latent_community == 2) %>%
    mutate(num(frequency, sigfig = 3)) %>%
    select(-frequency, -latent_community) %>% rename(frequency = 3)
lc_n %>%   kbl(caption = "Latent Community 2 species", escape = F) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, font_size = 8)
```
</div>
</div>

### Latent Community 3.
<div class = "row">
<div class = "column">

![](Figures/Latent community 3.png)
</div>
<div class = "column">

```{r echo = FALSE, results = "asis"}
lc_n <-  g1 %>% activate(nodes) %>% as_tibble() %>% filter(latent_community == 3) %>%
    mutate(num(frequency, sigfig = 3)) %>%
    select(-frequency, -latent_community) %>% rename(frequency = 3)
lc_n %>%   kbl(caption = "Latent Community 3 species", escape = F) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, font_size = 8)
```
</div>
</div>

### Latent Community 4.
<div class = "row">
<div class = "column">

![](Figures/Latent community 4.png)
</div>
<div class = "column">

```{r echo = FALSE, results = "asis"}
lc_n <-  g1 %>% activate(nodes) %>% as_tibble() %>% filter(latent_community == 4) %>%
    mutate(num(frequency, sigfig = 3)) %>%
    select(-frequency, -latent_community) %>% rename(frequency = 3)
lc_n %>%   kbl(caption = "Latent Community 4 species", escape = F) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, font_size = 8)
```
</div>
</div>

### Latent Community 5.
<div class = "row">
<div class = "column">

![](Figures/Latent community 5.png)
</div>
<div class = "column">

```{r echo = FALSE, results = "asis"}
lc_n <-  g1 %>% activate(nodes) %>% as_tibble() %>% filter(latent_community == 5) %>%
    mutate(num(frequency, sigfig = 3)) %>%
    select(-frequency, -latent_community) %>% rename(frequency = 3)
lc_n %>%   kbl(caption = "Latent Community 5 species", escape = F) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, font_size = 8)
```
</div>
</div>

### Latent Community 6.

<div class = "row">
<div class = "column">

![](Figures/Latent community 6.png)
</div>
<div class = "column">

```{r echo = FALSE, results = "asis"}
lc_n <-  g1 %>% activate(nodes) %>% as_tibble() %>% filter(latent_community == 6) %>%
    mutate(num(frequency, sigfig = 3)) %>%
    select(-frequency, -latent_community) %>% rename(frequency = 3)
lc_n %>%   kbl(caption = "Latent Community 6 species", escape = F) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, font_size = 8)
```
</div>
</div>

\pagebreak

### Latent Community 7.
<div class = "row">
<div class = "column">

![](Figures/Latent community 7.png)
</div>
<div class = "column">

```{r echo = FALSE, results = "asis"}
lc_n <-  g1 %>% activate(nodes) %>% as_tibble() %>% filter(latent_community == 7) %>%
    mutate(num(frequency, sigfig = 3)) %>%
    select(-frequency, -latent_community) %>% rename(frequency = 3)
lc_n %>%   kbl(caption = "Latent Community 7 species", escape = F) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, font_size = 8)
```
</div>
</div>

\pagebreak

### Latent Community 8.
<div class = "row">
<div class = "column">

![](Figures/Latent community 8.png)
</div>
<div class = "column">

```{r echo = FALSE, results = "asis"}
lc_n <-  g1 %>% activate(nodes) %>% as_tibble() %>% filter(latent_community == 8) %>%
    mutate(num(frequency, sigfig = 3)) %>%
    select(-frequency, -latent_community) %>% rename(frequency = 3)
lc_n %>%   kbl(caption = "Latent Community 8 species", escape = F) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, font_size = 7)
```
</div>
</div>

\pagebreak

## 3. Latent Community expression at survey sites.
Here is a summary of all the Latent Communities expressed at all the survey sites. Two features are immediately obvious:

1. Several LC may be expressed at a single site (Wood Field, Bushy Field, Lindfield Bridge).
2. Some sites have very low expression of any LC (Long Mead SE, SW; Pond field W).
We can investigate these sites to find out what is going on.

![](Figures/Site expressions of latent communities.png)
The pages following show the expressions of individual communities by site. The scale on the left hand side is the percentage of the maximum possible expression.

### Latent Community 1.

![](Figures/Site expression of latent community 1.png)

### Latent Community 2.

![](Figures/Site expression of latent community 2.png)

### Latent Community 3.

![](Figures/Site expression of latent community 3.png)

### Latent Community 4.

![](Figures/Site expression of latent community 4.png)

### Latent Community 5.

![](Figures/Site expression of latent community 5.png)

### Latent Community 6.

![](Figures/Site expression of latent community 6.png)

### Latent Community 7.

![](Figures/Site expression of latent community 7.png)

### Latent Community 8.

![](Figures/Site expression of latent community 8.png)


\pagebreak

## <a name="section4"></a> 4. Associative and dissociative links.

The information given to the SBM is that certain pairs of plants are not distributed independently in the data. The criterion for independence is a Fisher test on the pairwise contingency table with p<0.05. This says nothing about whether the plants occur more or less frequently than would be expected by chance.

The Fisher test also returns a value for the odds ratio. If odds ratio > 1, the relationship is associative, that is, the two plants occur together in the data more often than would be expected by chance. Otherwise it is dissociative. This information is included in the graphs of Section 2, and may be taken into account when interpreting the results. 

For example, LC1 could be characterised as dyads with any of several rather interesting plants, but not paired with *Lolium perenne*. The meadows where LC1 is most fully expressed are Gravetye East, Gravetye West and Plain Field North. I think I am correct that these are fields with a management history of intentional meadow restoration, and that would explain the presence of interesting plants; to the extent that *L perenne* is present at these sites, it could be interpreted as a relic from former more intensive management.

## 5. Where next?

Does an examination of the species composition of the latent communities, and their site-specific expressions, give us any understanding of the community organisation? There are possibilities; the case of LC1 is discussed in Section 4 above. Further:

* Latent Community 3 contains an assemblage of plants of damp or wet habitats. It is particularly expressed at Bushy Field, Daltons Meadow, Hanging Meadow, The Mead and White Coppice. This makes sense as these are all damp but well managed (from a wildflower meadow perspective).

* LC6 also includes plants from wet habitats, but maybe with a suggestion of higher nutrient level (*Urtica dioica*, *Rumex crispus*, *Rumex acutifolius*). Lindfield Bridge has the strongest expression of LC6; it is a riparine bank bordering a former agricultural field, and that could account for the assumed nutrients.

* Look at the graphs of LC1 and LC3. In both cases, the dominant species is a grass and in both cases, the grass has only dissociative links. Is it fair to assume that these links are directed? That is, that the grass is inhibiting the minor species and not the other way round?

* Is it the species poor sites that exhibit minimal LC expression?

These examples show that the SBM can generate predictions. They in turn need to be tested by further reference to the data, the literature or in the field.

## 6. Footnotes
^1^ Simple SBM treats the observation of a dyad with Fisher p<0.05 as a Bernouilli distributed event.
\pagebreak

## 7. Bibliography.
